<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murder Mystery - Dev Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f0f0f',
                            800: '#1a1a1a',
                            700: '#252525',
                            600: '#333333'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .composure-bar {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #22c55e 100%);
        }

        .pulse-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="bg-dark-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="glass sticky top-0 z-50 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <span class="text-2xl">üîç</span>
            <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                Murder Mystery Dashboard
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <nav class="flex items-center bg-dark-800 rounded-lg p-1 mr-4">
                <button onclick="showTab('game')" id="tab-game"
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-purple-600 text-white">Live
                    Game</button>
                <button onclick="showTab('tips')" id="tab-tips"
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">Daily
                    Tips</button>
                <button onclick="showTab('profiles')" id="tab-profiles"
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">User
                    Profiles</button>
                <button onclick="showTab('tokens')" id="tab-tokens"
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">Token
                    Logs</button>
                <button onclick="showTab('db')" id="tab-db"
                    class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">Database
                    Explorer</button>
            </nav>
            <div id="connectionStatus" class="flex items-center gap-2 text-sm">
                <span class="w-2 h-2 rounded-full bg-red-500 pulse-dot"></span>
                <span class="text-gray-400">Disconnected</span>
            </div>
        </div>
    </header>

    <main class="p-6 max-w-7xl mx-auto">
        <!-- Tabs Content -->
        <div id="tabContent-game" class="tab-content">
            <!-- No Game State -->
            <div id="noGame" class="text-center py-20">
                <div class="text-6xl mb-4">üïµÔ∏è</div>
                <h2 class="text-2xl font-semibold text-gray-300 mb-2">No Active Game</h2>
                <p class="text-gray-500">Start a murder mystery game with <code
                        class="bg-dark-700 px-2 py-1 rounded">/mma start</code></p>
            </div>

            <!-- Game Dashboard -->
            <div id="gameDashboard" class="hidden space-y-6">
                <!-- Game Status Bar -->
                <section class="glass rounded-xl p-6">
                    <div class="flex flex-wrap gap-6 items-center justify-between">
                        <div>
                            <h2 id="caseName" class="text-2xl font-bold text-white">The Blackwood Murder</h2>
                            <p id="casePhase" class="text-gray-400">Phase: <span
                                    class="text-purple-400">Investigating</span></p>
                        </div>
                        <div class="flex gap-8">
                            <div class="text-center">
                                <div id="timeRemaining" class="text-3xl font-bold text-amber-400">--:--</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wider">Time Left</div>
                            </div>
                            <div class="text-center">
                                <div id="points" class="text-3xl font-bold text-green-400">--</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wider">Points</div>
                            </div>
                            <div class="text-center">
                                <div id="participants" class="text-3xl font-bold text-blue-400">--</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wider">Players</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Suspects Grid -->
                <section>
                    <h3 class="text-lg font-semibold text-gray-300 mb-4 flex items-center gap-2">
                        <span>üë•</span> Suspects
                    </h3>
                    <div id="suspectsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Suspect cards inserted here -->
                    </div>
                </section>

                <!-- Bottom Row: Evidence + Events -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Discovered Evidence -->
                    <section class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-300 mb-4 flex items-center gap-2">
                            <span>üìÅ</span> Discovered Evidence
                        </h3>
                        <div id="evidenceList" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-gray-500 italic">No evidence discovered yet</p>
                        </div>
                    </section>

                    <!-- Event Feed -->
                    <section class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-300 mb-4 flex items-center gap-2">
                            <span>üìú</span> Event Log
                        </h3>
                        <div id="eventFeed" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-gray-500 italic">No events yet</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div id="tabContent-tips" class="tab-content hidden">
            <!-- Daily Tips Section -->
            <section class="glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-300 flex items-center gap-2">
                        <span>üí°</span> Daily Tips Status
                    </h3>
                    <div class="flex items-center gap-2">
                        <button onclick="cleanupInactiveServers()"
                            class="bg-red-900/30 hover:bg-red-900/50 text-red-400 text-xs font-bold px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1 border border-red-800/50">
                            <span>üßπ</span> Cleanup
                        </button>
                        <button onclick="addNewServer()"
                            class="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                            <span>+</span> Add Server
                        </button>
                    </div>
                </div>
                <div id="tipsInfo" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                    <p class="text-gray-500 italic py-4">Loading tips data...</p>
                </div>
            </section>
        </div>

        <div id="tabContent-profiles" class="tab-content hidden">
            <!-- User Profiles Section -->
            <section class="glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span>üë§</span> AI User Profiles
                    </h3>
                    <div class="flex items-center gap-2">
                        <span id="profilesCount" class="text-sm text-gray-400">Loading...</span>
                        <button onclick="loadProfiles()"
                            class="p-2 rounded-lg bg-dark-700 hover:bg-dark-600 text-gray-300 border border-gray-600/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="profilesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-500 italic py-4 col-span-full">Loading profiles...</p>
                </div>

                <div id="profilesPagination"
                    class="flex justify-between items-center mt-6 pt-4 border-t border-gray-800 hidden">
                    <span id="profilesPaginationInfo" class="text-sm text-gray-500"></span>
                    <div class="flex gap-2">
                        <button id="profilesPrevBtn"
                            class="px-3 py-1 rounded bg-dark-700 hover:bg-dark-600 text-sm disabled:opacity-30">Previous</button>
                        <button id="profilesNextBtn"
                            class="px-3 py-1 rounded bg-dark-700 hover:bg-dark-600 text-sm disabled:opacity-30">Next</button>
                    </div>
                </div>
            </section>
        </div>

        <div id="tabContent-tokens" class="tab-content hidden">
            <!-- Token Logs Section -->
            <section class="glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span>ü™ô</span> Token Consumption Logs
                    </h3>
                    <div class="flex items-center gap-2">
                        <span id="tokensCount" class="text-sm text-gray-400">Loading...</span>
                        <button onclick="loadTokens()"
                            class="p-2 rounded-lg bg-dark-700 hover:bg-dark-600 text-gray-300 border border-gray-600/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto -mx-6 px-6">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-dark-800/50 text-gray-400 font-medium border-y border-gray-700/50">
                            <tr>
                                <th class="px-4 py-3">Time</th>
                                <th class="px-4 py-3">Case ID</th>
                                <th class="px-4 py-3">Suspect/System</th>
                                <th class="px-4 py-3">Model</th>
                                <th class="px-4 py-3">Guild ID</th>
                                <th class="px-4 py-3 text-right">Prompt</th>
                                <th class="px-4 py-3 text-right">Completion</th>
                                <th class="px-4 py-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="tokensTableData" class="divide-y divide-gray-800/50">
                            <tr>
                                <td colspan="7" class="py-10 text-center text-gray-500">Loading token data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="tokensPagination"
                    class="flex justify-between items-center mt-6 pt-4 border-t border-gray-800 hidden">
                    <span id="tokensPaginationInfo" class="text-sm text-gray-500"></span>
                    <div class="flex gap-2">
                        <button id="tokensPrevBtn"
                            class="px-3 py-1 rounded bg-dark-700 hover:bg-dark-600 text-sm disabled:opacity-30">Previous</button>
                        <button id="tokensNextBtn"
                            class="px-3 py-1 rounded bg-dark-700 hover:bg-dark-600 text-sm disabled:opacity-30">Next</button>
                    </div>
                </div>
            </section>
        </div>

        <div id="tabContent-db" class="tab-content hidden">
            <!-- Database Explorer Section -->
            <section class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Sidebar: Table List -->
                <div class="lg:col-span-1 space-y-4">
                    <div class="glass rounded-xl p-4">
                        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Tables</h3>
                        <div id="tableList" class="space-y-1">
                            <!-- Tables will be listed here -->
                        </div>
                    </div>
                </div>

                <!-- Main: Table View -->
                <div class="lg:col-span-3 space-y-4">
                    <div class="glass rounded-xl p-6 overflow-hidden">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl" id="currentTableIcon">üìä</span>
                                <h2 class="text-xl font-bold text-white" id="currentTableName">Select a table</h2>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="rowCount" class="text-sm text-gray-500"></span>
                                <button onclick="refreshCurrentTable()" id="refreshDbBtn"
                                    class="hidden p-2 rounded-lg bg-dark-700 hover:bg-dark-600 text-gray-300 border border-gray-600/50">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto -mx-6">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead id="dbTableHeader"
                                    class="bg-dark-800/50 text-gray-400 font-medium border-y border-gray-700/50">
                                    <!-- Header columns -->
                                </thead>
                                <tbody id="dbTableBody" class="divide-y divide-gray-800/50">
                                    <tr>
                                        <td colspan="100%" class="py-20 text-center text-gray-500">
                                            Select a table from the left to explore data
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div id="dbPagination"
                            class="flex items-center justify-between mt-6 pt-6 border-t border-gray-800/50 hidden">
                            <span class="text-sm text-gray-500" id="paginationInfo">Showing 1 to 10 of 20 results</span>
                            <div class="flex gap-2">
                                <button id="prevBtn"
                                    class="px-3 py-1 rounded bg-dark-700 hover:bg-dark-600 disabled:opacity-30 disabled:cursor-not-allowed">Previous</button>
                                <button id="nextBtn"
                                    class="px-3 py-1 rounded bg-dark-700 hover:bg-dark-600 disabled:opacity-30 disabled:cursor-not-allowed">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Socket.IO connection
        const socket = io();

        // DOM elements
        const connectionStatus = document.getElementById('connectionStatus');
        const noGame = document.getElementById('noGame');
        const gameDashboard = document.getElementById('gameDashboard');
        const suspectsGrid = document.getElementById('suspectsGrid');
        const evidenceList = document.getElementById('evidenceList');
        const eventFeed = document.getElementById('eventFeed');

        // Connection status
        socket.on('connect', () => {
            connectionStatus.innerHTML = `
                <span class="w-2 h-2 rounded-full bg-green-500 pulse-dot"></span>
                <span class="text-gray-400">Connected</span>
            `;
        });

        socket.on('disconnect', () => {
            connectionStatus.innerHTML = `
                <span class="w-2 h-2 rounded-full bg-red-500 pulse-dot"></span>
                <span class="text-gray-400">Disconnected</span>
            `;
        });

        // State update
        socket.on('state', (state) => {
            if (!state) {
                noGame.classList.remove('hidden');
                gameDashboard.classList.add('hidden');
                return;
            }

            noGame.classList.add('hidden');
            gameDashboard.classList.remove('hidden');

            // Update header
            document.getElementById('caseName').textContent = state.caseName;
            document.getElementById('casePhase').innerHTML = `Phase: <span class="text-purple-400">${state.phase}</span>`;

            // Time remaining
            const mins = Math.floor(state.timeRemaining / 60);
            const secs = state.timeRemaining % 60;
            document.getElementById('timeRemaining').textContent =
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            document.getElementById('points').textContent = state.points;
            document.getElementById('participants').textContent = state.participantCount;

            // Suspects
            renderSuspects(state.suspects);

            // Evidence
            renderEvidence(state.discoveredEvidence);
        });

        // Single event
        socket.on('event', (event) => {
            addEventToFeed(event);
        });

        socket.on('events', (events) => {
            eventFeed.innerHTML = '';
            events.forEach(e => addEventToFeed(e));
        });

        // Tips update
        socket.on('tips', (tips) => {
            renderTips(tips);
        });

        function renderTips(tips) {
            const tipsInfo = document.getElementById('tipsInfo');
            if (!tips || !tips.servers || tips.servers.length === 0) {
                tipsInfo.innerHTML = '<p class="text-gray-500 italic py-4 col-span-full">No daily tips data available</p>';
                return;
            }

            tipsInfo.innerHTML = tips.servers.map(server => {
                const progress = tips.totalTips > 0 ? Math.round((server.currentTipIndex / tips.totalTips) * 100) : 0;

                return `
                <div class="bg-dark-800/50 rounded-lg p-4 border border-gray-700/50 relative group">
                    <button onclick="removeServer('${server.id}')" 
                            class="absolute top-2 right-2 p-1 text-red-500/50 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    <div class="flex items-center justify-between mb-2 pr-6">
                        <div class="flex items-center gap-2">
                            <button onclick="toggleService('${server.id}', ${!server.enabled})" 
                                    class="w-8 h-4 rounded-full relative transition-colors ${server.enabled ? 'bg-green-500' : 'bg-gray-600'}">
                                <div class="w-3 h-3 bg-white rounded-full absolute top-0.5 transition-all ${server.enabled ? 'left-[18px]' : 'left-0.5'}"></div>
                            </button>
                            <div class="text-xs font-bold text-purple-400 bg-purple-900/30 px-2 py-0.5 rounded">${server.name || server.id}</div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="flex items-center gap-1">
                                <div class="text-[10px] text-gray-500 font-mono">${server.channelName || server.channelId}</div>
                                <button onclick="updateChannel('${server.id}', '${server.channelId}')" class="text-gray-600 hover:text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-[10px] text-gray-600 uppercase">Lang:</span>
                                <div class="text-[10px] text-purple-400 font-bold">${server.language || 'English'}</div>
                                <button onclick="updateLanguage('${server.id}', '${server.language || 'English'}')" class="text-gray-600 hover:text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="text-right mb-4">
                        <span class="text-[10px] text-gray-600">Tip ${server.currentTipIndex + 1} of ${tips.totalTips}</span>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex flex-row gap-6">
                            <!-- Queued Tip -->
                            <div>
                                <span class="text-xs text-amber-400 font-bold uppercase tracking-wider">Pending (Sends Next)</span>
                                <div class="mt-2 flex items-center gap-3">
                                    ${server.currentTipUrl ? `
                                        <a href="${server.currentTipUrl}" target="_blank" class="w-48 h-48 rounded bg-dark-700 flex-shrink-0 overflow-hidden border-2 border-amber-500/50 shadow-[0_0_15px_rgba(245,158,11,0.1)]">
                                            <img src="${server.currentTipUrl}" class="w-full h-full object-cover">
                                        </a>
                                    ` : '<div class="w-48 h-48 rounded bg-dark-700 border border-gray-600"></div>'}
                                </div>
                            </div>

                            <!-- Next Tip -->
                            <div>
                                <span class="text-xs text-gray-500 uppercase tracking-wider">Following</span>
                                <div class="mt-2 flex flex-col gap-2 opacity-50">
                                    ${server.nextTipUrl ? `
                                        <a href="${server.nextTipUrl}" target="_blank" class="w-48 h-48 rounded bg-dark-700 flex-shrink-0 overflow-hidden border border-gray-700">
                                            <img src="${server.nextTipUrl}" class="w-full h-full object-cover">
                                        </a>
                                    ` : '<div class="w-48 h-48 rounded bg-dark-700 border border-gray-600"></div>'}
                                </div>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="pt-2">
                            <div class="flex justify-between text-[10px] mb-1">
                                <span class="text-gray-500">Progress</span>
                                <span class="text-gray-400">${progress}%</span>
                            </div>
                            <div class="h-1 bg-dark-900 rounded-full overflow-hidden">
                                <div class="h-full bg-green-500 transition-all duration-1000" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <!-- Manual Controls -->
                        <div class="pt-2 flex items-center gap-2">
                            <div class="flex-1 flex items-center gap-1 bg-dark-900 rounded p-1">
                                <input type="number" id="index-${server.id}" value="${server.currentTipIndex}" min="0" max="${tips.totalTips - 1}"
                                       class="w-12 bg-transparent text-xs text-center border-none focus:ring-0 text-white">
                                <button onclick="updateTipIndex('${server.id}')" 
                                        class="text-[10px] bg-purple-600 hover:bg-purple-500 text-white px-2 py-1 rounded transition-colors whitespace-nowrap">
                                    Set Index
                                </button>
                            </div>
                            <button onclick="triggerTip('${server.id}')" 
                                    class="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-3 py-2 rounded transition-colors flex items-center gap-1">
                                üöÄ Send
                            </button>
                        </div>
                        
                        ${tips.lastSent ? `
                            <div class="text-[10px] text-gray-600 text-right">
                                Last sent: ${new Date(tips.lastSent).toLocaleString()}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
        }

        function renderSuspects(suspects) {
            suspectsGrid.innerHTML = suspects.map(s => `
                <div class="glass rounded-xl p-4 ${s.isGuilty ? 'ring-2 ring-red-500/50' : ''}">
                    <div class="flex items-center gap-3 mb-4">
                        <img src="${s.avatar}" alt="${s.name}" 
                             class="w-12 h-12 rounded-full bg-dark-600 object-cover"
                             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(s.name)}&background=333&color=fff'">
                        <div>
                            <h4 class="font-semibold text-white">${s.name}</h4>
                            <p class="text-xs text-gray-500">
                                ${s.revealedSecrets.length}/${s.totalSecrets} secrets revealed
                                ${s.isBusy ? '<span class="text-amber-400 ml-2">‚óè Responding...</span>' : ''}
                            </p>
                        </div>
                        ${s.isGuilty ? '<span class="ml-auto text-red-400 text-xs font-medium uppercase">Killer</span>' : ''}
                    </div>
                    
                    <!-- Composure -->
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Composure</span>
                            <span class="${s.composure > 50 ? 'text-green-400' : s.composure > 25 ? 'text-amber-400' : 'text-red-400'}">${s.composure}%</span>
                        </div>
                        <div class="h-2 bg-dark-900 rounded-full overflow-hidden">
                            <div class="composure-bar h-full rounded-full transition-all duration-500" 
                                 style="width: ${s.composure}%"></div>
                        </div>
                    </div>
                    
                    <!-- Defensiveness -->
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Defensiveness</span>
                            <span class="text-purple-400">${s.defensiveness}%</span>
                        </div>
                        <div class="h-2 bg-dark-900 rounded-full overflow-hidden">
                            <div class="h-full rounded-full bg-purple-500 transition-all duration-500" 
                                 style="width: ${s.defensiveness}%"></div>
                        </div>
                    </div>
                    
                    <!-- Secrets & Triggers -->
                    <details class="mt-3 pt-3 border-t border-gray-700">
                        <summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-300">
                            üîê Secret Triggers (${s.secrets?.length || 0})
                        </summary>
                        <div class="mt-2 space-y-3">
                            ${(s.secrets || []).map(sec => `
                                <div class="p-2 rounded ${sec.revealed ? 'bg-red-900/30 border border-red-800' : 'bg-dark-800 border border-gray-700'}">
                                    <div class="flex items-start gap-2 mb-2">
                                        <span class="text-sm">${sec.revealed ? 'üîì' : 'üîí'}</span>
                                        <span class="text-xs ${sec.revealed ? 'text-red-300' : 'text-gray-300'}">${sec.text}</span>
                                    </div>
                                    <div class="pl-5 space-y-1">
                                        ${sec.trigger.requiresEvidence.length > 0 ? `
                                            <div class="flex flex-wrap gap-1">
                                                <span class="text-xs text-gray-500">Evidence:</span>
                                                ${sec.trigger.requiresEvidence.map(e => `
                                                    <span class="text-xs px-1.5 py-0.5 rounded ${sec.trigger.hasRequiredEvidence ? 'bg-green-900/50 text-green-300' : 'bg-gray-800 text-gray-400'}">${e}</span>
                                                `).join('')}
                                                ${sec.trigger.hasRequiredEvidence ? '<span class="text-green-400 text-xs">‚úì</span>' : '<span class="text-gray-500 text-xs">‚úó</span>'}
                                            </div>
                                        ` : ''}
                                        ${sec.trigger.keywords.length > 0 ? `
                                            <div class="flex flex-wrap gap-1">
                                                <span class="text-xs text-gray-500">Keywords:</span>
                                                ${sec.trigger.keywords.slice(0, 5).map(k => `<span class="text-xs px-1.5 py-0.5 rounded bg-blue-900/50 text-blue-300">${k}</span>`).join('')}
                                                ${sec.trigger.keywords.length > 5 ? `<span class="text-xs text-gray-500">+${sec.trigger.keywords.length - 5}</span>` : ''}
                                            </div>
                                        ` : ''}
                                        <div class="text-xs text-gray-500">
                                            Pressure needed: <span class="text-amber-400">${sec.trigger.minPressure}%</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                </div>
            `).join('');
        }

        function renderEvidence(evidence) {
            if (!evidence || evidence.length === 0) {
                evidenceList.innerHTML = '<p class="text-gray-500 italic">No evidence discovered yet</p>';
                return;
            }

            // Sort by type then name
            const sorted = [...evidence].sort((a, b) => {
                if (a.type !== b.type) return a.type.localeCompare(b.type);
                return a.name.localeCompare(b.name);
            });

            evidenceList.innerHTML = `
                <div class="grid grid-cols-1 gap-3">
                    ${sorted.map(e => {
                const icon = getEvidenceIcon(e.type);
                const typeLabel = e.type.toUpperCase();

                return `
                        <div class="evidence-item group p-3 rounded-lg bg-dark-800/40 border border-gray-700/30 hover:border-purple-500/50 transition-all duration-300">
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg leading-none">${icon}</span>
                                    <span class="text-[10px] font-bold text-gray-500 tracking-widest">${typeLabel}</span>
                                </div>
                                <span class="text-[9px] text-gray-600 font-mono opacity-0 group-hover:opacity-100 transition-opacity">ID: ${e.id}</span>
                            </div>
                            <div class="text-sm font-bold text-gray-100">${e.name}</div>
                            ${e.description ? `
                                <div class="mt-2 text-[11px] text-gray-400 leading-relaxed border-l-2 border-purple-500/30 pl-3 py-1 bg-purple-500/5 rounded-r">
                                    ${e.description}
                                </div>
                            ` : ''}
                        </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function getEvidenceIcon(type) {
            switch (type) {
                case 'location': return 'üìç';
                case 'dna': return 'üß¨';
                case 'log': return 'üìú';
                case 'physical': return 'üì¶';
                default: return '‚ùì';
            }
        }

        function addEventToFeed(event) {
            const icons = {
                interrogation: 'üí¨',
                tool_use: 'üîß',
                secret_revealed: 'üîì',
                game_start: 'üéÆ',
                game_end: 'üèÅ'
            };

            const time = new Date(event.timestamp).toLocaleTimeString();
            const el = document.createElement('div');
            el.className = 'flex items-start gap-2 text-sm py-1 border-b border-gray-800';
            el.innerHTML = `
                <span>${icons[event.type] || 'üìå'}</span>
                <span class="text-gray-500 shrink-0">${time}</span>
                <span class="text-gray-300">${event.message}</span>
            `;

            eventFeed.insertBefore(el, eventFeed.firstChild);

            // Keep only last 50 visible
            while (eventFeed.children.length > 50) {
                eventFeed.removeChild(eventFeed.lastChild);
            }
        }

        async function updateTipIndex(serverId) {
            const index = document.getElementById(`index-${serverId}`).value;
            try {
                const response = await fetch('/api/tips/set-index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serverId, index })
                });
                const data = await response.json();
                if (data.error) alert(`Error: ${data.error}`);
            } catch (err) {
                console.error(err);
                alert('Failed to update index');
            }
        }

        async function triggerTip(serverId) {
            if (!confirm('Are you sure you want to trigger this tip manually?')) return;

            try {
                const response = await fetch('/api/tips/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serverId })
                });
                const data = await response.json();
                if (data.error) alert(`Error: ${data.error}`);
                else alert('Tip sent successfully!');
            } catch (err) {
                console.error(err);
                alert('Failed to trigger tip');
            }
        }

        async function toggleService(serverId, enabled) {
            try {
                const response = await fetch('/api/tips/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serverId, enabled })
                });
                const data = await response.json();
                if (data.error) alert(`Error: ${data.error}`);
            } catch (err) {
                console.error(err);
                alert('Failed to toggle service');
            }
        }

        async function updateChannel(serverId, currentId) {
            const newId = prompt('Enter new Channel ID:', currentId);
            if (!newId || newId === currentId) return;

            try {
                const response = await fetch('/api/tips/update-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serverId, channelId: newId })
                });
                const data = await response.json();
                if (data.error) alert(`Error: ${data.error}`);
            } catch (err) {
                console.error(err);
                alert('Failed to update channel');
            }
        }

        async function addNewServer() {
            const serverId = prompt('Enter Server ID:');
            if (!serverId) return;
            const channelId = prompt('Enter Tips Channel ID:');
            if (!channelId) return;

            try {
                const response = await fetch('/api/tips/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serverId, channelId })
                });
                const data = await response.json();
                if (data.error) alert(`Error: ${data.error}`);
                else alert('Server added successfully!');
            } catch (err) {
                console.error(err);
                alert('Failed to add server');
            }
        }

        async function updateLanguage(serverId, currentLang) {
            const newLang = prompt('Enter target language (e.g. Spanish, French, Portuguese):', currentLang);
            if (!newLang || newLang === currentLang) return;

            try {
                const response = await fetch('/api/tips/set-language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serverId, language: newLang })
                });
                const data = await response.json();
                if (data.error) alert(`Error: ${data.error}`);
            } catch (err) {
                console.error(err);
                alert('Failed to update language');
            }
        }

        async function removeServer(serverId) {
            if (!confirm(`Are you sure you want to remove server ${serverId}? This will delete all its data from the bot.`)) return;

            try {
                const response = await fetch('/api/tips/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serverId })
                });
                const data = await response.json();
                if (data.error) alert(`Error: ${data.error}`);
            } catch (err) {
                console.error(err);
                alert('Failed to remove server');
            }
        }

        async function cleanupInactiveServers() {
            if (!confirm('Are you sure you want to remove all servers where the bot is not present?')) return;

            try {
                const response = await fetch('/api/tips/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.error) alert(`Error: ${data.error}`);
                else alert(`Successfully removed ${data.removedCount} inactive servers.`);
            } catch (err) {
                console.error(err);
                alert('Failed to cleanup servers');
            }
        }

        // Tab System
        function showTab(tabId) {
            // Update buttons
            document.querySelectorAll('nav button').forEach(btn => {
                if (btn.id === `tab-${tabId}`) {
                    btn.classList.add('bg-purple-600', 'text-white');
                    btn.classList.remove('text-gray-400', 'hover:text-white');
                } else {
                    btn.classList.remove('bg-purple-600', 'text-white');
                    btn.classList.add('text-gray-400', 'hover:text-white');
                }
            });

            // Update content blocks
            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id === `tabContent-${tabId}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });

            if (tabId === 'db') {
                loadTables();
            } else if (tabId === 'profiles') {
                loadProfiles();
            } else if (tabId === 'tokens') {
                loadTokens();
            }
        }

        let profilesOffset = 0;
        const profilesLimit = 12;

        async function loadProfiles(offset = 0) {
            profilesOffset = offset;
            const grid = document.getElementById('profilesGrid');
            const countLabel = document.getElementById('profilesCount');

            try {
                grid.innerHTML = '<p class="text-gray-500 italic py-4 col-span-full text-center">Loading profiles...</p>';
                const response = await fetch(`/api/profiles?limit=${profilesLimit}&offset=${offset}`);
                const data = await response.json();

                countLabel.textContent = `${data.total} Total Profiles`;

                if (!data.profiles || data.profiles.length === 0) {
                    grid.innerHTML = '<p class="text-gray-500 italic py-8 col-span-full text-center">No compiled user profiles in database.</p>';
                    document.getElementById('profilesPagination').classList.add('hidden');
                    return;
                }

                grid.innerHTML = data.profiles.map(p => {
                    const updateDate = new Date(p.lastUpdated).toLocaleString();
                    return `
                        <div class="bg-dark-800/60 border border-gray-700/50 hover:border-purple-500/50 transition-colors rounded-xl p-5 flex flex-col h-full">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-bold text-white text-lg">${p.userId}</h4>
                                    <span class="text-xs bg-dark-900 px-2 py-1 rounded text-gray-400 border border-gray-800" title="Guild ID">${p.guildId}</span>
                                </div>
                                <div class="text-xs bg-purple-900/30 text-purple-300 font-bold px-2 py-1 rounded">
                                    ${p.messageCount} msgs
                                </div>
                            </div>
                            <div class="text-sm text-gray-300 flex-grow whitespace-pre-wrap leading-relaxed mt-2">${p.profile}</div>
                            <div class="mt-4 pt-3 border-t border-gray-700/50 text-right text-[10px] text-gray-500 uppercase tracking-widest">
                                Scan of ${updateDate}
                            </div>
                        </div>
                    `;
                }).join('');

                // Pagination configuration
                document.getElementById('profilesPagination').classList.remove('hidden');
                document.getElementById('profilesPaginationInfo').textContent =
                    `Showing ${offset + 1} to ${Math.min(offset + profilesLimit, data.total)} of ${data.total} profiles`;

                const prev = document.getElementById('profilesPrevBtn');
                const next = document.getElementById('profilesNextBtn');

                prev.disabled = offset === 0;
                prev.onclick = () => loadProfiles(Math.max(0, offset - profilesLimit));

                next.disabled = offset + profilesLimit >= data.total;
                next.onclick = () => loadProfiles(offset + profilesLimit);

            } catch (err) {
                console.error('Failed to load profiles:', err);
                grid.innerHTML = '<p class="text-red-400 py-4 col-span-full text-center">Failed to load profiles.</p>';
            }
        }

        let tokensOffset = 0;
        const tokensLimit = 50;

        async function loadTokens(offset = 0) {
            tokensOffset = offset;
            const tableData = document.getElementById('tokensTableData');
            const countLabel = document.getElementById('tokensCount');

            try {
                tableData.innerHTML = '<tr><td colspan="7" class="py-10 text-center text-gray-500">Loading token data...</td></tr>';
                const response = await fetch(`/api/tokens?limit=${tokensLimit}&offset=${offset}`);
                const data = await response.json();

                countLabel.textContent = `${data.total} Total AI Requests`;

                if (!data.logs || data.logs.length === 0) {
                    tableData.innerHTML = '<tr><td colspan="7" class="py-10 text-center text-gray-500">No token logs found.</td></tr>';
                    document.getElementById('tokensPagination').classList.add('hidden');
                    return;
                }

                tableData.innerHTML = data.logs.map(log => {
                    const time = new Date(log.createdAt).toLocaleString();
                    const isSystem = log.suspectId && log.suspectId.startsWith('system_');
                    const isTotalHigh = log.totalTokens > 5000;

                    return `
                        <tr class="hover:bg-dark-800/30 transition-colors border-b border-gray-800/50 last:border-0">
                            <td class="px-4 py-3 text-gray-400 whitespace-nowrap">${time}</td>
                            <td class="px-4 py-3 text-purple-300 font-mono text-xs">${log.caseId || '‚Äî'}</td>
                            <td class="px-4 py-3">
                                ${isSystem
                            ? `<span class="text-xs bg-amber-900/30 text-amber-300 px-2 py-0.5 rounded border border-amber-800/50">${log.suspectId}</span>`
                            : `<span class="font-medium text-gray-300">${log.suspectId || 'system'}</span>`
                        }
                            </td>
                            <td class="px-4 py-3 text-xs text-blue-300 font-mono">${log.model}</td>
                            <td class="px-4 py-3 text-xs text-gray-400 font-mono">${log.guildId || '‚Äî'}</td>
                            <td class="px-4 py-3 text-right text-gray-400">${log.promptTokens.toLocaleString()}</td>
                            <td class="px-4 py-3 text-right text-gray-400">${log.completionTokens.toLocaleString()}</td>
                            <td class="px-4 py-3 text-right ${isTotalHigh ? 'text-red-400 font-bold' : 'text-green-400 font-bold'}">
                                ${log.totalTokens.toLocaleString()}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Pagination configuration
                document.getElementById('tokensPagination').classList.remove('hidden');
                document.getElementById('tokensPaginationInfo').textContent =
                    `Showing ${offset + 1} to ${Math.min(offset + tokensLimit, data.total)} of ${data.total} requests`;

                const prev = document.getElementById('tokensPrevBtn');
                const next = document.getElementById('tokensNextBtn');

                prev.disabled = offset === 0;
                prev.onclick = () => loadTokens(Math.max(0, offset - tokensLimit));

                next.disabled = offset + tokensLimit >= data.total;
                next.onclick = () => loadTokens(offset + tokensLimit);

            } catch (err) {
                console.error('Failed to load tokens:', err);
                tableData.innerHTML = '<tr><td colspan="7" class="py-10 text-center text-red-500">Failed to load token logs.</td></tr>';
            }
        }

        // Database Explorer Logic
        let currentTable = null;
        let currentOffset = 0;
        const pageLimit = 20;

        async function loadTables() {
            try {
                const response = await fetch('/api/db/tables');
                const data = await response.json();
                const tableList = document.getElementById('tableList');

                tableList.innerHTML = data.tables.map(table => `
                    < button onclick = "viewTable('${table}')" class= "w-full text-left px-3 py-2 rounded-lg text-sm transition-all ${currentTable === table ? 'bg-purple-600/20 text-purple-400 font-bold' : 'text-gray-400 hover:bg-dark-700 hover:text-white'}" >
                    ${getTableIcon(table)} ${table}
                    </button >
                    `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        function getTableIcon(table) {
            if (table.includes('Game')) return 'üéÆ';
            if (table.includes('User')) return 'üë§';
            if (table.includes('Server')) return 'üñ•Ô∏è';
            if (table.includes('Tip')) return 'üí°';
            return 'üìÑ';
        }

        async function viewTable(tableName, offset = 0) {
            currentTable = tableName;
            currentOffset = offset;

            document.getElementById('currentTableName').textContent = tableName;
            document.getElementById('currentTableIcon').textContent = getTableIcon(tableName);
            document.getElementById('refreshDbBtn').classList.remove('hidden');

            // Highlight selected table in list
            document.querySelectorAll('#tableList button').forEach(btn => {
                const isSelected = btn.textContent.includes(tableName);
                btn.className = `w - full text - left px - 3 py - 2 rounded - lg text - sm transition - all ${isSelected ? 'bg-purple-600/20 text-purple-400 font-bold' : 'text-gray-400 hover:bg-dark-700 hover:text-white'} `;
            });

            try {
                const response = await fetch(`/ api / db / table / ${tableName}?limit = ${pageLimit}& offset=${offset} `);
                const data = await response.json();

                renderTable(data);
            } catch (err) {
                console.error(err);
                alert('Failed to load table data');
            }
        }

        function renderTable(data) {
            const header = document.getElementById('dbTableHeader');
            const body = document.getElementById('dbTableBody');

            // Render Header
            header.innerHTML = `
                    < tr >
                    ${data.columns.map(col => `
                        <th class="px-6 py-3 font-semibold uppercase tracking-wider">${col.name}</th>
                    `).join('')
                }
                </tr >
                    `;

            // Render Body
            if (data.rows.length === 0) {
                body.innerHTML = `< tr > <td colspan="100%" class="py-20 text-center text-gray-500 italic text-lg">No data found in this table</td></tr > `;
                document.getElementById('rowCount').textContent = '0 rows';
                document.getElementById('dbPagination').classList.add('hidden');
                return;
            }

            body.innerHTML = data.rows.map(row => `
                    < tr class="hover:bg-dark-800/30 transition-colors" >
                        ${data.columns.map(col => {
                const val = row[col.name];
                let displayVal = val;

                // Smart formatting for JSON or long text
                if (typeof val === 'string' && (val.startsWith('{') || val.startsWith('['))) {
                    try {
                        const parsed = JSON.parse(val);
                        displayVal = `<button onclick='alert(${JSON.stringify(val).replace(/'/g, "&apos;")})' class="text-xs bg-dark-700 hover:bg-dark-600 px-1.5 py-0.5 rounded text-purple-400 font-mono">JSON (${Object.keys(parsed).length})</button>`;
                    } catch (e) { }
                } else if (typeof val === 'string' && val.length > 50) {
                    displayVal = `<span title="${val}">${val.substring(0, 50)}...</span>`;
                } else if (val === null) {
                    displayVal = `<span class="text-gray-600 italic">null</span>`;
                } else if (typeof val === 'boolean') {
                    displayVal = val ? '<span class="text-green-500">true</span>' : '<span class="text-red-500">false</span>';
                }

                return `<td class="px-6 py-4 text-gray-300 max-w-xs truncate">${displayVal}</td>`;
            }).join('')
                }
                </tr >
                    `).join('');

            // Pagination
            document.getElementById('rowCount').textContent = `${data.total} rows`;
            document.getElementById('dbPagination').classList.remove('hidden');
            document.getElementById('paginationInfo').textContent = `Showing ${data.offset + 1} to ${Math.min(data.offset + data.limit, data.total)} of ${data.total} results`;

            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = data.offset === 0;
            prevBtn.onclick = () => viewTable(currentTable, Math.max(0, data.offset - pageLimit));

            nextBtn.disabled = data.offset + data.limit >= data.total;
            nextBtn.onclick = () => viewTable(currentTable, data.offset + pageLimit);
        }

        function refreshCurrentTable() {
            if (currentTable) viewTable(currentTable, currentOffset);
        }
    </script>
</body>

</html>